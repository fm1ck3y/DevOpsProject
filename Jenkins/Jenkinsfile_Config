pipeline {
    agent {
        label 'AWS-Agent'
    }
    parameters {
        string(name: 'weight_api_without_json', defaultValue: '1', description: 'Weight  for api without json:')
        string(name: 'weight_api_with_json', defaultValue: '1', description: 'Weight  for api with json:')

    }

    environment {
        PATH_TO_DOCKER_COMPOSE = "/opt/ApiWithNginx/docker-compose.yml"
        PATH_TO_NGINX_CONF_LOCAL = "/opt/ApiWithNginx/nginx/nginx.conf"
        PATH_TO_NGINX_CONF_DOCKER = "/etc/nginx/conf.d/default.conf"
        PATH_TO_TEMPLATE_NGINX_CONF = "/opt/ApiWithNginx/nginx/nginx.conf.template"
        PATH_TO_SCRIPT_NGINX_CONF = "/opt/ApiWithNginx/nginx/conf.d/change_configuration.py"
    }


    stages {
        stage('Change weights in nginx.conf'){
            when { expression { return params.selected_type_job == 'Change Configuration' } }
                steps {
                    sh "sudo python3 ${env.PATH_TO_SCRIPT_NGINX_CONF} ${params.weight_api_without_json} ${params.weight_api_with_json}"
                    sh "sudo docker-compose -f ${env.PATH_TO_DOCKER_COMPOSE} restart"
                }
        }
    }
}